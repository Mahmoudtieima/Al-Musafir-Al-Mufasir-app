<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿßŸÑŸÖÿ≥ÿßŸÅÿ± ÿßŸÑŸÖŸÅÿ≥ÿ± | Tadabbur Al-Qur'an</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Crimson+Pro:wght@300;400;500;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --ink: #1a1a1a;
            --ink-light: #4a4a4a;
            --parchment: #faf8f5;
            --parchment-dark: #f0ebe4;
            --gold: #b8860b;
            --gold-light: #d4a84b;
            --sage: #5d7a64;
            --sage-light: #8fa894;
            --cream: #fdfcfa;
        }

        body {
            font-family: 'IBM Plex Sans', sans-serif;
            direction: rtl;
            background: linear-gradient(145deg, var(--parchment) 0%, var(--parchment-dark) 100%);
            min-height: 100vh;
        }

        .arabic-text, .arabic-heading, .arabic-input {
            font-family: 'Amiri', serif;
        }

        .rtl-content { direction: rtl; }
        .ltr-content { direction: ltr; }

        /* Contemplative Thinking Animation */
        .thinking-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 2rem;
        }

        .thinking-orb {
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            border-radius: 50%;
            animation: breathe 2s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(184, 134, 11, 0.3);
        }

        .thinking-orb:nth-child(2) { animation-delay: 0.3s; }
        .thinking-orb:nth-child(3) { animation-delay: 0.6s; }

        @keyframes breathe {
            0%, 100% {
                transform: scale(1);
                opacity: 0.4;
            }
            50% {
                transform: scale(1.4);
                opacity: 1;
            }
        }

        .thinking-text {
            font-family: 'Crimson Pro', serif;
            font-size: 1.1rem;
            font-weight: 400;
            color: var(--ink-light);
            letter-spacing: 0.05em;
            margin-top: 1rem;
            animation: fadeInOut 2s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Streaming Response Container */
        .stream-response {
            position: relative;
            background: var(--cream);
            border: 1px solid rgba(184, 134, 11, 0.2);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow:
                0 4px 6px -1px rgba(0, 0, 0, 0.05),
                0 2px 4px -1px rgba(0, 0, 0, 0.03),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .stream-response::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            border-radius: 1rem 1rem 0 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stream-response.streaming::before {
            opacity: 1;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Typing Cursor */
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: var(--gold);
            margin-left: 2px;
            vertical-align: text-bottom;
            animation: blink 0.8s ease-in-out infinite;
        }

        .rtl-content .typing-cursor {
            margin-left: 0;
            margin-right: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Text reveal animation for streamed content */
        .stream-response p,
        .stream-response h1,
        .stream-response h2,
        .stream-response h3,
        .stream-response li {
            animation: textReveal 0.3s ease-out;
        }

        @keyframes textReveal {
            from {
                opacity: 0.7;
            }
            to {
                opacity: 1;
            }
        }

        /* Legacy loader - keep for non-streaming loaders */
        .loader {
            border: 3px solid var(--parchment-dark);
            border-top: 3px solid var(--gold);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Gemini Content Typography */
        .gemini-content {
            font-family: 'Crimson Pro', serif;
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--ink);
        }
        .gemini-content.ltr-content { direction: ltr; text-align: left; }
        .gemini-content.rtl-content { direction: rtl; text-align: right; font-family: 'Amiri', serif; }

        .gemini-content h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: var(--ink);
            border-bottom: 1px solid var(--gold);
            padding-bottom: 0.5rem;
        }
        .gemini-content h2 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-top: 1.75rem;
            margin-bottom: 0.75rem;
            color: var(--ink);
        }
        .gemini-content h3 {
            font-size: 1.15rem;
            font-weight: 500;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--ink-light);
        }
        .gemini-content h4 {
            font-size: 1.05rem;
            font-weight: 500;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--ink-light);
        }
        .gemini-content p { margin-bottom: 1.25rem; }
        .gemini-content strong { font-weight: 600; color: var(--ink); }
        .gemini-content em { font-style: italic; color: var(--ink-light); }
        .gemini-content ul, .gemini-content ol { margin-bottom: 1.25rem; padding-left: 1.5rem; }
        .gemini-content.rtl-content ul, .gemini-content.rtl-content ol { padding-right: 1.5rem; padding-left: 0; }
        .gemini-content ul { list-style-type: disc; }
        .gemini-content ol { list-style-type: decimal; }
        .gemini-content li { margin-bottom: 0.5rem; }
        .gemini-content code {
            background-color: var(--parchment-dark);
            color: var(--sage);
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.9em;
            font-family: 'IBM Plex Mono', monospace;
        }
        .gemini-content pre {
            background-color: var(--ink);
            color: var(--parchment);
            padding: 1.25rem;
            border-radius: 0.75rem;
            overflow-x: auto;
            margin-bottom: 1.25rem;
        }
        .gemini-content pre code { background-color: transparent; color: inherit; padding: 0; }
        .gemini-content a { color: var(--gold); text-decoration: underline; text-underline-offset: 2px; transition: color 0.2s; }
        .gemini-content a:hover { color: var(--gold-light); }

        /* Navigation & Controls */
        .nav-arrow {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--ink-light);
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.5;
        }
        .nav-arrow:hover { color: var(--gold); opacity: 1; }
        .nav-arrow:disabled { color: var(--parchment-dark); cursor: not-allowed; opacity: 0.3; }

        .lang-btn {
            padding: 0.5rem 1.25rem;
            border: 1px solid rgba(184, 134, 11, 0.3);
            background: var(--cream);
            color: var(--ink-light);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .lang-btn:first-child { border-radius: 0 0.5rem 0.5rem 0; }
        .lang-btn:last-child { border-radius: 0.5rem 0 0 0.5rem; }
        .lang-btn.active-lang {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            color: white;
            border-color: var(--gold);
        }

        .model-btn {
            background-color: transparent;
            color: var(--ink-light);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .model-btn.active-model {
            background: linear-gradient(135deg, var(--sage) 0%, var(--sage-light) 100%);
            color: white;
        }
        .model-btn:hover:not(.active-model) { background-color: var(--parchment-dark); color: var(--ink); }

        /* Primary Action Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(184, 134, 11, 0.25);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(184, 134, 11, 0.35);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--sage) 0%, var(--sage-light) 100%);
            color: white;
            font-weight: 600;
            padding: 0.875rem 2rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(93, 122, 100, 0.25);
        }
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(93, 122, 100, 0.35);
        }
    /* Main container */
        .main-card {
            background: var(--cream);
            border-radius: 1.5rem;
            box-shadow:
                0 10px 40px -10px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(184, 134, 11, 0.1);
        }

        /* Input focus states */
        input:focus, select:focus {
            outline: none;
            border-color: var(--gold) !important;
            box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.15);
        }

        /* Section dividers */
        .section-divider {
            border-color: var(--parchment-dark);
            border-style: dashed;
        }

        /* Header styling */
        .app-title {
            color: var(--ink);
        }
        .app-title .highlight {
            color: var(--gold);
        }

        /* Verse display */
        .verse-container {
            background: var(--cream);
            border: 1px solid var(--parchment-dark);
            border-radius: 1rem;
        }
    </style>
</head>
<body style="color: var(--ink)">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        
        <header class="text-center mb-8">
            <h1 class="arabic-heading text-4xl md:text-5xl app-title">
                <span>ÿßŸÑŸÄ</span><span class="highlight">ŸÖÿ≥ÿßŸÅÿ±</span><span> ÿßŸÑŸÄ</span><span class="highlight">ŸÖŸÅÿ≥ÿ±</span>
            </h1>
            <p class="text-lg mt-3 ltr-content tracking-widest text-center" style="color: var(--ink-light); font-family: 'Crimson Pro', serif; font-style: italic;">The Traveller, The Interpreter</p>
        </header>

        <div id="lang-selector" class="flex justify-center mb-6">
            <button id="lang-en" class="lang-btn active-lang">English</button>
            <button id="lang-ar" class="lang-btn">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
        </div>

        <main class="main-card p-6 md:p-8 min-h-[400px] mb-24">
            
            <div id="loading-state" class="hidden text-center">
                <div class="loader"></div>
                <p class="text-slate-500" data-lang-key="loadingQuran"></p>
            </div>
            
            <div id="error-state" class="hidden text-center p-8 bg-red-50 text-red-700 rounded-lg">
                <h3 class="font-bold text-lg mb-2" data-lang-key="connectionError"></h3>
                <p data-lang-key="connectionErrorMsg"></p>
            </div>

            <div id="app-content">
                <!-- Verse Selection -->
                <div class="flex flex-col md:flex-row gap-4 mb-8 rtl-content">
                    <div class="flex-1"><label for="surah-select" class="block mb-2 text-sm font-medium text-slate-700" data-lang-key="selectSurah"></label><select id="surah-select" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block p-2.5"></select></div>
                    <div class="flex-1"><label for="verse-select" class="block mb-2 text-sm font-medium text-slate-700" data-lang-key="selectVerse"></label><select id="verse-select" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block p-2.5"></select></div>
                </div>
                
                <div id="basmalah-display" class="hidden text-center mb-4">
                    <p class="arabic-text text-2xl text-slate-600">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸëŸéŸáŸê ÿßŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê</p>
                </div>

                <div class="flex items-center justify-between gap-3 mb-8">
                    <button id="prev-verse-btn" class="nav-arrow" aria-label="Previous Verse">‚Äπ</button>
                    <div class="verse-container p-8 min-h-[120px] flex flex-col items-center justify-center w-full">
                        <p id="arabic-verse" class="arabic-text text-3xl md:text-4xl text-center leading-loose" style="color: var(--ink)"></p>
                        <p id="english-verse" class="ltr-content text-center mt-4" style="color: var(--ink-light); font-family: 'Crimson Pro', serif; font-style: italic; font-size: 1.1rem;"></p>
                    </div>
                    <button id="next-verse-btn" class="nav-arrow" aria-label="Next Verse">‚Ä∫</button>
                </div>
                
                <!-- Verse Tadabbur Section -->
                <div class="pt-6 border-t rtl-content" style="border-color: var(--parchment-dark)">
                    <div class="text-center mb-4">
                        <button id="gemini-btn" class="btn-primary" data-lang-key="deepenVerse"></button>
                    </div>
                    <div id="gemini-loader" class="hidden mt-4">
                        <div class="thinking-container">
                            <div class="thinking-orb"></div>
                            <div class="thinking-orb"></div>
                            <div class="thinking-orb"></div>
                        </div>
                        <p class="thinking-text text-center" data-lang-key="contemplating"></p>
                    </div>
                    <div id="gemini-response" class="mt-4 hidden gemini-content stream-response"></div>
                </div>

                <!-- Exploration Tools Section -->
                <div class="mt-10 pt-6 border-t-2 border-dashed rtl-content" style="border-color: var(--parchment-dark)">
                    <h2 class="arabic-heading text-3xl text-center mb-6" style="color: var(--ink)" data-lang-key="explorationTools"></h2>
                    <div class="mb-8">
                        <label for="theme-input" class="block mb-2 text-lg font-semibold" style="color: var(--ink)" data-lang-key="thematicExploration"></label>
                        <div class="flex gap-2">
                            <input type="text" id="theme-input" class="arabic-input w-full p-3 border border-slate-200 rounded-lg bg-white focus:ring-2 focus:ring-gold focus:border-transparent" data-lang-key="themePlaceholder">
                            <button id="theme-btn" class="btn-primary whitespace-nowrap" data-lang-key="explore"></button>
                        </div>
                        <div id="theme-loader" class="hidden mt-4">
                            <div class="thinking-container">
                                <div class="thinking-orb"></div>
                                <div class="thinking-orb"></div>
                                <div class="thinking-orb"></div>
                            </div>
                            <p class="thinking-text text-center" data-lang-key="exploring"></p>
                        </div>
                        <div id="theme-response" class="mt-4 hidden gemini-content stream-response"></div>
                    </div>
                    <div>
                        <label for="root-input" class="block mb-2 text-lg font-semibold" style="color: var(--ink)" data-lang-key="rootCompass"></label>
                        <div class="flex gap-2">
                            <input type="text" id="root-input" class="arabic-input w-full p-3 border border-slate-200 rounded-lg bg-white focus:ring-2 focus:ring-gold focus:border-transparent" data-lang-key="rootPlaceholder">
                            <button id="root-btn" class="btn-primary whitespace-nowrap" data-lang-key="analyze"></button>
                        </div>
                        <div id="root-loader" class="hidden mt-4">
                            <div class="thinking-container">
                                <div class="thinking-orb"></div>
                                <div class="thinking-orb"></div>
                                <div class="thinking-orb"></div>
                            </div>
                            <p class="thinking-text text-center" data-lang-key="analyzing"></p>
                        </div>
                        <div id="root-response" class="mt-4 hidden gemini-content stream-response"></div>
                    </div>
                </div>

                 <!-- Daily Reflection Section -->
                <div class="mt-10 pt-6 border-t-2 border-dashed rtl-content" style="border-color: var(--parchment-dark)">
                    <div class="text-center">
                        <button id="daily-reflection-btn" class="btn-secondary text-lg" data-lang-key="dailyReflection"></button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Global State ---
        let quranCache = {}; 
        let fullMetadata = {};
        let selectedLanguage = 'en';
        let selectedModel = 'fast'; // Default to fast model
        let responseCache = {}; // Cache responses to avoid re-processing
        // API Configuration - uses relative path in production
        const API_ENDPOINT = "/api/gemini";
        
        // Simple hash function for cache keys to prevent collisions
        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return hash.toString(36);
        }

        // --- Translation Dictionary ---
        const translations = {
            en: { selectSurah: "Select Surah", selectVerse: "Select Verse", verse: "Verse", deepenVerse: "‚ú® Deepen Understanding of Verse", explorationTools: "Exploration Tools", thematicExploration: "Thematic Exploration", themePlaceholder: "e.g., Gratitude, Trust, Patience...", explore: "Explore", rootCompass: "Root-Word Compass", rootPlaceholder: "e.g., ÿ±ÿ≠ŸÖ, ŸÅŸÑÿ≠, ÿπŸÑŸÖ...", analyze: "Analyze", dailyReflection: "Receive a Daily Reflection", contemplating: "Contemplating...", exploring: "Exploring...", analyzing: "Analyzing...", loadingQuran: "Loading Qur'an data...", connectionError: "Connection Error", connectionErrorMsg: "Could not connect to the Qur'an libraries. Please check your internet connection and try again.", modelSpeed: "Model Speed:", fast: "‚ö° Fast", thinking: "üß† Thinking" },
            ar: { selectSurah: "ÿßÿÆÿ™ÿ± ÿßŸÑÿ≥Ÿàÿ±ÿ©", selectVerse: "ÿßÿÆÿ™ÿ± ÿßŸÑÿ¢Ÿäÿ©", verse: "ÿßŸÑÿ¢Ÿäÿ©", deepenVerse: "‚ú® ÿ™ÿØÿ®ÿ± ÿ£ÿπŸÖŸÇ ŸÑŸÑÿ¢Ÿäÿ©", explorationTools: "ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ŸÉÿ¥ÿßŸÅ", thematicExploration: "ÿ®ÿ≠ÿ´ ŸÖŸàÿ∂ŸàÿπŸä", themePlaceholder: "ŸÖÿ´ÿßŸÑ: ÿßŸÑÿµÿ®ÿ±ÿå ÿßŸÑÿ¥ŸÉÿ±ÿå ÿßŸÑÿ™ŸàŸÉŸÑ...", explore: "ÿßÿ≥ÿ™ŸÉÿ¥ŸÅ", rootCompass: "ÿ®ŸàÿµŸÑÿ© ÿßŸÑÿ¨ÿ∞ÿ±", rootPlaceholder: "ŸÖÿ´ÿßŸÑ: ÿ±ÿ≠ŸÖÿå ŸÅŸÑÿ≠ÿå ÿπŸÑŸÖ...", analyze: "ÿ≠ŸÑŸÑ", dailyReflection: "ÿßÿ≥ÿ™ŸÇÿ®ŸÑ ÿ™ÿØÿ®ÿ±Ÿãÿß ŸäŸàŸÖŸäŸãÿß", contemplating: "Ÿäÿ™ÿØÿ®ÿ±...", exploring: "Ÿäÿ≥ÿ™ŸÉÿ¥ŸÅ...", analyzing: "Ÿäÿ≠ŸÑŸÑ...", loadingQuran: "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿ±ÿ¢ŸÜ...", connectionError: "ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ", connectionErrorMsg: "ÿ™ÿπÿ∞ÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÖŸÉÿ™ÿ®ÿßÿ™ ÿßŸÑŸÇÿ±ÿ¢ŸÜ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑŸÉ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.", modelSpeed: "ÿ≥ÿ±ÿπÿ© ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨:", fast: "‚ö° ÿ≥ÿ±Ÿäÿπ", thinking: "üß† ÿ™ŸÅŸÉŸäÿ±" }
        };

        // --- DOM Elements ---
        const surahSelect = document.getElementById('surah-select');
        const verseSelect = document.getElementById('verse-select');
        const arabicVerseEl = document.getElementById('arabic-verse');
        const englishVerseEl = document.getElementById('english-verse');
        const basmalahDisplay = document.getElementById('basmalah-display');
        const loadingStateEl = document.getElementById('loading-state');
        const errorStateEl = document.getElementById('error-state');
        const appContentEl = document.getElementById('app-content');
        const geminiBtn = document.getElementById('gemini-btn');
        const geminiLoader = document.getElementById('gemini-loader');
        const geminiResponseEl = document.getElementById('gemini-response');
        const nextVerseBtn = document.getElementById('next-verse-btn');
        const prevVerseBtn = document.getElementById('prev-verse-btn');
        const langEnBtn = document.getElementById('lang-en');
        const langArBtn = document.getElementById('lang-ar');
                const themeInput = document.getElementById('theme-input');
        const themeBtn = document.getElementById('theme-btn');
        const themeLoader = document.getElementById('theme-loader');
        const themeResponse = document.getElementById('theme-response');
        const rootInput = document.getElementById('root-input');
        const rootBtn = document.getElementById('root-btn');
        const rootLoader = document.getElementById('root-loader');
        const rootResponse = document.getElementById('root-response');
        const dailyReflectionBtn = document.getElementById('daily-reflection-btn');

        // --- Backup API Configuration ---
        const QURAN_APIS = [
            { metaUrl: 'https://api.alquran.cloud/v1/meta', surahUrl: (num) => `https://api.alquran.cloud/v1/surah/${num}/editions/quran-uthmani,en.sahih`, parseMeta: (data) => data.data.surahs.references, parseSurah: (data) => ({ ...data.data[0], englishAyahs: data.data[1].ayahs }) }
        ];

        // --- Functions ---

        function setLanguage(lang) {
            selectedLanguage = lang;
            const langStrings = translations[lang];
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (langStrings[key]) {
                    if (el.tagName === 'INPUT') el.placeholder = langStrings[key];
                    else el.textContent = langStrings[key];
                }
            });
            langEnBtn.classList.toggle('active-lang', lang === 'en');
            langArBtn.classList.toggle('active-lang', lang === 'ar');
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            if (Object.keys(fullMetadata).length > 0) {
                populateSurahDropdown();
                const currentSurahData = quranCache[surahSelect.value];
                if (currentSurahData) {
                    populateVerses(currentSurahData);
                    displayVerse(currentSurahData, parseInt(verseSelect.value));
                }
            }
        }
        
        function setLoading(isLoading) { loadingStateEl.classList.toggle('hidden', !isLoading); appContentEl.classList.toggle('hidden', isLoading); errorStateEl.classList.add('hidden'); }
        function showError() { loadingStateEl.classList.add('hidden'); appContentEl.classList.add('hidden'); errorStateEl.classList.remove('hidden'); }

        function populateSurahDropdown() {
            const currentVal = surahSelect.value;
            surahSelect.innerHTML = '';
            fullMetadata.forEach(surah => {
                const option = document.createElement('option');
                option.value = surah.number;
                option.textContent = selectedLanguage === 'ar' 
                    ? `${surah.number}. ${surah.name}`
                    : `${surah.number}. ${surah.englishName}`;
                surahSelect.appendChild(option);
            });
            surahSelect.value = currentVal || 1;
        }

        async function populateSurahList() {
            for (const api of QURAN_APIS) {
                try {
                    const response = await fetch(api.metaUrl);
                    if (!response.ok) throw new Error('API response not ok');
                    const data = await response.json();
                    fullMetadata = api.parseMeta(data);
                    populateSurahDropdown();
                    return;
                } catch (error) { console.warn(`Primary API for metadata failed, trying backup...`, error); }
            }
            showError();
        }

        async function getSurahData(surahNumber) {
            if (quranCache[surahNumber]) return quranCache[surahNumber];
            for (const api of QURAN_APIS) {
                try {
                    const response = await fetch(api.surahUrl(surahNumber));
                    if (!response.ok) throw new Error('API response not ok');
                    const data = await response.json();
                    const parsedData = api.parseSurah(data);
                    quranCache[surahNumber] = parsedData;
                    return parsedData;
                } catch (error) { console.warn(`Primary API for Surah ${surahNumber} failed, trying backup...`, error); }
            }
            showError(); return null;
        }

        function populateVerses(surahData) {
            const currentVal = verseSelect.value;
            verseSelect.innerHTML = '';
            surahData.ayahs.forEach(ayah => {
                const option = document.createElement('option');
                option.value = ayah.numberInSurah;
                option.textContent = `${translations[selectedLanguage].verse} ${ayah.numberInSurah}`;
                verseSelect.appendChild(option);
            });
            verseSelect.value = currentVal || 1;
        }

        function displayVerse(surahData, verseNumber) {
            const verseData = surahData.ayahs[verseNumber - 1];
            const englishVerseData = surahData.englishAyahs[verseNumber - 1];
            if (!verseData || !englishVerseData) return;
            
            let arabicText = verseData.text;
            let englishText = englishVerseData.text;
            const basmalahArabic = "ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸëŸéŸáŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê";
            
            const surahNum = surahData.number;
            if (surahNum > 1 && surahNum !== 9) {
                basmalahDisplay.classList.remove('hidden');
                if (verseNumber === 1 && arabicText.trim().startsWith(basmalahArabic)) {
                    arabicText = arabicText.replace(basmalahArabic, '').trim();
                }
            } else {
                basmalahDisplay.classList.add('hidden');
            }

            arabicVerseEl.textContent = arabicText;
            englishVerseEl.textContent = englishText;
            englishVerseEl.style.display = selectedLanguage === 'en' ? 'block' : 'none';

            verseSelect.value = verseNumber;
            geminiResponseEl.classList.add('hidden');
            geminiResponseEl.innerHTML = '';
            prevVerseBtn.disabled = verseNumber === 1;
            nextVerseBtn.disabled = verseNumber === surahData.numberOfAyahs;
        }
        
        // Helper function to format streaming text incrementally
        function formatStreamingText(text) {
            if (!text) return '';
            
            let html = text;
            
            // Step 1: Protect code blocks first (replace with placeholders)
            const codeBlocks = [];
            html = html.replace(/```([\s\S]*?)```/g, function(match, code) {
                const placeholder = `___CODE_BLOCK_${codeBlocks.length}___`;
                codeBlocks.push('<pre><code>' + code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code></pre>');
                return placeholder;
            });
            
            // Step 2: Protect inline code
            const inlineCodes = [];
            html = html.replace(/`([^`]+)`/g, function(match, code) {
                const placeholder = `___INLINE_CODE_${inlineCodes.length}___`;
                inlineCodes.push('<code>' + code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code>');
                return placeholder;
            });
            
            // Step 3: Escape HTML first (but code blocks are protected)
            html = html
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Step 4: Process lists (after escaping, so we match escaped patterns)
            const lines = html.split('\n');
            let inList = false;
            let listType = '';
            let processedLines = [];
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                // Match list items (accounting for escaped asterisks)
                const unorderedMatch = line.match(/^[\*\-\+] (.+)$/);
                const orderedMatch = line.match(/^\d+\. (.+)$/);
                
                if (unorderedMatch) {
                    if (!inList || listType !== 'ul') {
                        if (inList) {
                            processedLines.push('&lt;/' + listType + '&gt;');
                        }
                        processedLines.push('&lt;ul&gt;');
                        inList = true;
                        listType = 'ul';
                    }
                    processedLines.push('&lt;li&gt;' + unorderedMatch[1] + '&lt;/li&gt;');
                } else if (orderedMatch) {
                    if (!inList || listType !== 'ol') {
                        if (inList) {
                            processedLines.push('&lt;/' + listType + '&gt;');
                        }
                        processedLines.push('&lt;ol&gt;');
                        inList = true;
                        listType = 'ol';
                    }
                    processedLines.push('&lt;li&gt;' + orderedMatch[1] + '&lt;/li&gt;');
                } else {
                    if (inList) {
                        processedLines.push('&lt;/' + listType + '&gt;');
                        inList = false;
                        listType = '';
                    }
                    processedLines.push(line);
                }
            }
            
            if (inList) {
                processedLines.push('&lt;/' + listType + '&gt;');
            }
            
            html = processedLines.join('\n');
            
            // Step 5: Unescape list HTML tags (but keep content escaped)
            html = html.replace(/&lt;(ul|ol|li)&gt;/g, '<$1>');
            html = html.replace(/&lt;\/(ul|ol|li)&gt;/g, '</$1>');
            
            // Step 6: Restore code blocks and inline code (they're already escaped)
            codeBlocks.forEach((block, i) => {
                html = html.replace(`___CODE_BLOCK_${i}___`, block);
            });
            inlineCodes.forEach((code, i) => {
                html = html.replace(`___INLINE_CODE_${i}___`, code);
            });
            
            // Step 7: Process headers
            html = html.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // Step 8: Bold (**text** or __text__)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // Step 9: Italic (*text* or _text_)
            html = html.replace(/\*\*/g, '___BOLD_PLACEHOLDER___');
            html = html.replace(/\*([^*\n]+?)\*/g, '<em>$1</em>');
            html = html.replace(/___BOLD_PLACEHOLDER___/g, '**');
            
            html = html.replace(/__/g, '___BOLD_PLACEHOLDER2___');
            html = html.replace(/_([^_\n]+?)_/g, '<em>$1</em>');
            html = html.replace(/___BOLD_PLACEHOLDER2___/g, '__');
            
            // Step 10: Links [text](url)
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
            
            // Step 11: Convert double newlines to paragraphs
            html = html.split('\n\n').map(para => {
                para = para.trim();
                if (!para) return '';
                // Don't wrap if it's already a block element
                if (/^<(h[1-6]|ul|ol|pre|code|p)/.test(para)) {
                    return para;
                }
                return '<p>' + para + '</p>';
            }).join('');
            
            // Step 12: Single newlines become <br>
            html = html.replace(/(<\/p>)\n(<p>)/g, '$1$2');
            html = html.replace(/\n/g, '<br>');
            
            return html;
        }
        
        // Helper to add typing cursor
        function addTypingCursor(el) {
            // Remove existing cursor first
            const existingCursor = el.querySelector('.typing-cursor');
            if (existingCursor) existingCursor.remove();
            // Add new cursor at the end
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            el.appendChild(cursor);
        }

        // Helper to remove typing cursor
        function removeTypingCursor(el) {
            const cursor = el.querySelector('.typing-cursor');
            if (cursor) cursor.remove();
        }

        // Streaming version using Server-Sent Events (SSE) or ReadableStream
        async function callGeminiStreaming(prompt, loaderEl, responseEl, lang) {
            loaderEl.classList.remove('hidden');
            responseEl.classList.add('hidden');
            responseEl.classList.remove('streaming');
            responseEl.innerHTML = '';
            responseEl.classList.remove('ltr-content', 'rtl-content');
            responseEl.classList.add(lang === 'ar' ? 'rtl-content' : 'ltr-content');

            let accumulatedText = '';
            const cacheKey = `${hashString(prompt)}_${lang}_${selectedModel}`;

            try {
                // Check cache first
                if (responseCache[cacheKey]) {
                    console.log("Using cached response");
                    const cachedText = responseCache[cacheKey];
                    responseEl.innerHTML = formatStreamingText(cachedText);
                    loaderEl.classList.add('hidden');
                    responseEl.classList.remove('hidden');
                    return;
                }

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    modelType: selectedModel
                };

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                // Read the streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let streamComplete = false;

                // Show response element immediately when first chunk arrives
                let firstChunkReceived = false;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    // Decode chunk and add to buffer
                    buffer += decoder.decode(value, { stream: true });
                    
                    // Process complete lines (SSE format: "data: {...}\n\n")
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (!trimmedLine) continue;
                        
                        // Handle SSE format: "data: {...}"
                        if (trimmedLine.startsWith('data: ')) {
                            const data = trimmedLine.slice(6).trim();
                            
                            // Check for completion marker
                            if (data === '[DONE]') {
                                streamComplete = true;
                                break;
                            }
                            
                            // Parse JSON data
                            try {
                                const parsed = JSON.parse(data);
                                
                                // Handle text chunks
                                if (parsed.text) {
                                    accumulatedText += parsed.text;

                                    // Show response on first chunk
                                    if (!firstChunkReceived) {
                                        firstChunkReceived = true;
                                        responseEl.classList.remove('hidden');
                                        responseEl.classList.add('streaming');
                                        loaderEl.classList.add('hidden');
                                    }

                                    // Update UI with formatted text + cursor
                                    responseEl.innerHTML = formatStreamingText(accumulatedText);
                                    addTypingCursor(responseEl);

                                    // Auto-scroll to bottom to follow the stream
                                    responseEl.scrollTop = responseEl.scrollHeight;
                                } 
                                // Handle errors
                                else if (parsed.error) {
                                    throw new Error(parsed.error.message || JSON.stringify(parsed.error));
                                }
                            } catch (parseError) {
                                // If not valid JSON, try treating as plain text
                                if (data && data !== '[DONE]') {
                                    accumulatedText += data;
                                    if (!firstChunkReceived) {
                                        firstChunkReceived = true;
                                        responseEl.classList.remove('hidden');
                                        loaderEl.classList.add('hidden');
                                    }
                                    responseEl.innerHTML = formatStreamingText(accumulatedText);
                                }
                            }
                        }
                        // Handle non-SSE format (plain JSON lines)
                        else if (trimmedLine.startsWith('{')) {
                            try {
                                const parsed = JSON.parse(trimmedLine);
                                if (parsed.text) {
                                    accumulatedText += parsed.text;
                                    if (!firstChunkReceived) {
                                        firstChunkReceived = true;
                                        responseEl.classList.remove('hidden');
                                        loaderEl.classList.add('hidden');
                                    }
                                    responseEl.innerHTML = formatStreamingText(accumulatedText);
                                } else if (parsed.error) {
                                    throw new Error(parsed.error.message || JSON.stringify(parsed.error));
                                }
                            } catch (e) {
                                // Ignore parse errors for non-JSON lines
                            }
                        }
                    }
                    
                    if (streamComplete) break;
                }
                
                // Process any remaining buffer content
                if (buffer.trim() && !streamComplete) {
                    const trimmedBuffer = buffer.trim();
                    if (trimmedBuffer.startsWith('data: ')) {
                        const data = trimmedBuffer.slice(6).trim();
                        if (data !== '[DONE]') {
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.text) {
                                    accumulatedText += parsed.text;
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        }
                    }
                }
                
                // Final update and cache
                if (accumulatedText) {
                    responseEl.innerHTML = formatStreamingText(accumulatedText);
                    responseCache[cacheKey] = accumulatedText;
                } else {
                    throw new Error("No content received from stream");
                }
                
            } catch (error) {
                console.error("Streaming API Error:", error);
                responseEl.innerHTML = `<p class="text-red-500 text-center">Sorry, a reflection could not be generated. ${error.message}</p>`;
            } finally {
                // Clean up streaming state
                removeTypingCursor(responseEl);
                responseEl.classList.remove('streaming');
                loaderEl.classList.add('hidden');
                responseEl.classList.remove('hidden');
            }
        }
        
        // Always use streaming
        async function callGemini(prompt, loaderEl, responseEl, lang) {
            return callGeminiStreaming(prompt, loaderEl, responseEl, lang);
        }

        function getMasterPrompt() {
            return `You are a specialized AI assistant for Tadabbur al-Qur'an. Your entire analysis MUST be based on the principle that the Qur'an explains itself. 
            **Quarantine Protocol:** Do NOT use any external sources (historical stories, Hadith, classical tafsir) as the primary basis for your explanation. You must build your understanding from the Qur'anic text alone.
            **Translation Mandate:** When the response language is English, every Arabic word or quoted verse MUST be immediately followed by its English translation in parentheses. For example: "The word ÿßŸÑÿ≠ŸÖÿØ (Al-Hamd)..." or "...as mentioned in 'ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá ÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßŸÑÿ±ÿ≠ŸäŸÖ' (In the name of Allah, the Entirely Merciful, the Especially Merciful)." This is crucial for reader comprehension.
            **Some Rules that You need to see the Text through:**
            1. Every root of the word is indicating one specific meaning but used in different facets & ways.
            2. The root Word can be used in the same way but indicate different facets of the meaning (e.g., the different meanings of 'ÿ∂ÿ±ÿ®').
            3. The root word can be placed into different morphological patterns (ÿ£Ÿàÿ≤ÿßŸÜ) which changes its direction but not its core meaning. Pay close attention to the specific pattern (Ÿàÿ≤ŸÜ), for example, the difference between ŸÅÿπŸÑÿßŸÜ (Fa'laan), ŸÅÿπŸäŸÑ (Fa'eel), and ŸÅÿπÿßŸÑ (Fa'aal).
            4. Take into consideration of depths of meaning including all facets of life (ŸÉÿ™ÿßÿ® ŸÖÿ´ÿßŸÜŸä - Depths & Dualistic in nature).
            5. Some verses are interconnected even if they are in different suras & make a web of a perfect map.
            6. There is no contradiction in the quran.
            7. There are different facets of the same subject.
            8. There are some letters which acts as words (e.g., ÿ® in ÿ®ÿ≥ŸÖ).
            9. The Quranic arabic is a language in itself & we are discovering the meaning from it by itself.
            10. Consider all the ways the root word comes in (e.g., ŸÖÿ≠ŸÖÿØÿå ÿ£ÿ≠ŸÖÿØÿå ŸÖÿ≠ŸÖŸàÿØ).
            11. ÿßŸÑŸÇÿ±ÿ¢ŸÜ ŸäŸÅÿ≥ÿ± ÿ®ÿπÿ∂Ÿá ÿ®ÿπÿ∂ÿß ŸàŸÑÿß ŸäŸÑÿ≤ŸÖ ŸÑŸÅŸáŸÖŸá ÿßŸÑŸÖÿπÿßÿ¨ŸÖ ÿßŸà ÿßŸÑÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ®ŸàŸä.
            12. The Quran has a lot of different subjects as Whole systems.
            13. The Quran also has a lot of metaphors & teachings through Stories.
            14. The Principle of Perspective and Voice (ŸÖŸÜÿ∏Ÿàÿ± ÿßŸÑŸÖÿ™ŸÉŸÑŸÖ ŸàÿßŸÑŸÖÿÆÿßÿ∑ÿ®): Always consider who is speaking (Allah, the Prophet, an angel, etc.) and to whom they are speaking (the believers, all of humanity, etc.) to understand the full context and depth of the message, & When God mentions himself as (ŸÜÿ≠ŸÜ) Consider that he is talking as Him & The Systems that he created(Universe) so there is difference when he says (ÿ£ŸÜÿß) & (ŸÜÿ≠ŸÜ).
            15. The Principle of Qur'anic Temporality (ÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÇÿ±ÿ¢ŸÜ): Pay special attention to verb tenses.
            16. The Principle of the Two Worlds (ÿπÿßŸÑŸÖ ÿßŸÑÿ∫Ÿäÿ® ŸàÿπÿßŸÑŸÖ ÿßŸÑÿ¥ŸáÿßÿØÿ©) Coherent with the Duality nature of the Quran: Analyze how the verse unfolds through a Duality Perspective if You can see it.
            17. The Principle of Pairs and Opposites (ÿßŸÑÿ£ÿ≤Ÿàÿßÿ¨ ÿßŸÑŸÖÿ™ŸÇÿßÿ®ŸÑÿ©): When analyzing a key concept, keep in consideration its opposite or counterpart in the Qur'an (e.g., Gratitude/ÿßŸÑÿ¥ŸÉÿ± vs. Ingratitude/ÿßŸÑŸÉŸÅÿ±). The Qur'an often defines concepts in relation to their opposites to reveal their full meaning.
            18. The Principle of Precedence and Emphasis (ÿßŸÑÿ™ŸÇÿØŸäŸÖ ŸàÿßŸÑÿ™ÿ£ÿÆŸäÿ±): Pay close attention to word order. When a word is brought forward in a sentence (like ÿ•ŸêŸäŸëŸéÿßŸÉŸé in ÿ•ŸêŸäŸëŸéÿßŸÉŸé ŸÜŸéÿπŸíÿ®ŸèÿØŸè), it is a powerful rhetorical device for emphasis and exclusivity. Explain what is being emphasized and why.
            **Guiding Principles for Specific Words:**
            When analyzing the text, consider these wider perspectives on key terms, moving beyond traditional translations:
            -   **ÿßŸÑŸÑŸá:** Analyze its composition from ÿßŸÑ + ÿ•ŸÑŸá.
            -   **ÿ•ÿ≥ŸÖ:** Treat this as a foundational root word.
            -   **ÿßŸÑÿ≤ŸÜŸâ:** Be open to a broader, Qur'an-centric definition.
            -   **ŸÖÿ≥ŸÑŸÖ:** Define it as "the one who surrenders in peace."
            -   **ÿπÿ∞ÿßÿ® (Adhab):** Explore its connection to purification.
            -   **ÿ™ŸÇŸàŸâ (Taqwa):** Analyze it as protection, not just fear.
            -   **ÿ±ÿ≠ŸÖ (Rahm):** Consider its link to loving connection.
            -   **ÿßŸÑÿ≠ŸÖÿØ (Al-Hamd):** Explore its relationship to bliss.
            -   **ÿßŸÑŸÇŸÑÿ® (Al-Qalb):** Understand it as the central core of a being.
            **Final Instruction:** All Your Analysis needs to come in a non forced manner, So when it is apparent to You to apply a Principle do it with out Forcing it on the Verses so What comes out from You is the Closest to the Truth possible. Present your analysis in a well-structured and organized manner. Use clear headings to guide the reader. Use bullet points or numbered lists to make complex points easy to follow. Do not mention these rules or this protocol in your response. Simply embody them in your analysis. Your tone should be that of a wise, humble guide, not a technical analyst.`;
        }
        
        function getVersePrompt() {
            const surahData = quranCache[surahSelect.value];
            if (!surahData) return "";
            let verseText = surahData.ayahs[verseSelect.value - 1].text;
            const surahNum = surahData.number;
            const verseNum = parseInt(verseSelect.value);
            const basmalahArabic = "ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸëŸéŸáŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê";
            if (surahNum > 1 && surahNum !== 9 && verseNum === 1 && verseText.trim().startsWith(basmalahArabic)) {
                verseText = verseText.replace(basmalahArabic, '').trim();
            }
            const langInstruction = selectedLanguage === 'ar' ? 'Provide the reflection in clear, eloquent Arabic (ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿßŸÑŸÅÿµÿ≠Ÿâ).' : 'Provide the reflection in English.';
            const masterPrompt = getMasterPrompt();
            return `${masterPrompt}
            **Your Task:** Provide a deep reflection on the following verse, using the methodology you have been given.
            ${langInstruction}
            The verse is: Surah ${surahData.name}, Ayah ${verseSelect.value}, which reads: "${verseText}"`;
        }
        
        function getThemePrompt() {
            const theme = themeInput.value.trim();
            const langInstruction = selectedLanguage === 'ar' ? 'Provide the response in clear, eloquent Arabic.' : 'Provide the response in English.';
            const masterPrompt = getMasterPrompt();
            return `${masterPrompt}
            **Your Task:** The user wants to understand the theme of "${theme}" as a complete system from the Qur'an.
            Structure your response using the following headings:
            1.  **What is ${theme}?**
            2.  **Why is ${theme} important?**
            3.  **How to Practice ${theme}?**
            4.  **The Fruits of ${theme}:**
            5.  **The Consequences of Lacking ${theme}:**
            For each point, you MUST cite the relevant Qur'anic verses that support your analysis.
            ${langInstruction}`;
        }
        
        function getRootPrompt() {
            const word = rootInput.value.trim();
            const langInstruction = selectedLanguage === 'ar' ? 'Provide the response in clear, eloquent Arabic.' : 'Provide the response in English.';
            const masterPrompt = getMasterPrompt();
            return `${masterPrompt}
            **Your Task:** The user has provided the root or a word from it: "${word}".
            1.  **Identify the three-letter root (ÿßŸÑÿ¨ÿ∞ÿ±)**.
            2.  **Explain the core, intrinsic meaning** of this root.
            3.  **Systematically list the different derivative words** that appear in the Qur'an from this root.
            4.  For **each derivative**, provide one example verse.
            5.  Briefly explain how the derivative's meaning in the verse connects back to the core meaning of the root.
            ${langInstruction}`;
        }

        // --- Event Handlers ---
        async function getVerseReflection() {
            geminiBtn.disabled = true;
            await callGemini(getVersePrompt(), geminiLoader, geminiResponseEl, selectedLanguage);
            geminiBtn.disabled = false;
        }

        async function getThematicExploration() {
            if (!themeInput.value.trim()) return;
            themeBtn.disabled = true;
            await callGemini(getThemePrompt(), themeLoader, themeResponse, selectedLanguage);
            themeBtn.disabled = false;
        }
        
        async function getRootAnalysis() {
            if (!rootInput.value.trim()) return;
            rootBtn.disabled = true;
            await callGemini(getRootPrompt(), rootLoader, rootResponse, selectedLanguage);
            rootBtn.disabled = false;
        }
        
        async function getRandomVerse() {
            dailyReflectionBtn.disabled = true;
            setLoading(true);
            
            const randomSurahNum = Math.floor(Math.random() * 114) + 1;
            const surahData = await getSurahData(randomSurahNum);
            
            if (surahData) {
                const randomVerseNum = Math.floor(Math.random() * surahData.numberOfAyahs) + 1;
                surahSelect.value = randomSurahNum;
                populateSurahDropdown();
                populateVerses(surahData);
                verseSelect.value = randomVerseNum;
                displayVerse(surahData, randomVerseNum);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            setLoading(false);
            dailyReflectionBtn.disabled = false;
        }
        
        surahSelect.addEventListener('change', async (e) => {
            setLoading(true);
            const surahNumber = e.target.value;
            const surahData = await getSurahData(surahNumber);
            if (surahData) {
                populateVerses(surahData);
                displayVerse(surahData, 1);
            }
            setLoading(false);
        });
        verseSelect.addEventListener('change', (e) => {
            const surahData = quranCache[surahSelect.value];
            if(surahData) displayVerse(surahData, parseInt(e.target.value));
        });
        nextVerseBtn.addEventListener('click', () => {
            const surahData = quranCache[surahSelect.value];
            if(surahData) displayVerse(surahData, parseInt(verseSelect.value) + 1);
        });
        prevVerseBtn.addEventListener('click', () => {
            const surahData = quranCache[surahSelect.value];
            if(surahData) displayVerse(surahData, parseInt(verseSelect.value) - 1);
        });
        langEnBtn.addEventListener('click', () => setLanguage('en'));
        langArBtn.addEventListener('click', () => setLanguage('ar'));
        
                
        geminiBtn.addEventListener('click', getVerseReflection);
        themeBtn.addEventListener('click', getThematicExploration);
        rootBtn.addEventListener('click', getRootAnalysis);
        dailyReflectionBtn.addEventListener('click', getRandomVerse);

        // --- Initial Load ---
        async function initializeApp() {
            setLoading(true);
            await populateSurahList();
            if (Object.keys(fullMetadata).length > 0) {
                const initialSurahData = await getSurahData(1);
                if (initialSurahData) {
                    surahSelect.value = 1; 
                    populateVerses(initialSurahData);
                    verseSelect.value = 1;
                    displayVerse(initialSurahData, 1);
                }
            }
            setLanguage('en');
            setLoading(false);
        }

        initializeApp();
    </script>
</body>
</html>
